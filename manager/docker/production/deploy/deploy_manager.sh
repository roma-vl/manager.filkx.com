#!/bin/bash
set -e

COLOR=$1
APP_DIR="/var/www/manager.filkx.com"
RELEASE_DIR="$APP_DIR/$COLOR/current"
DOCKER_COMPOSE_FILE="$RELEASE_DIR/docker-compose.yml"
WORKDIR_IN_CONTAINER="/var/www/html"

# ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∏
if [[ "$COLOR" != "blue" && "$COLOR" != "green" ]]; then
  echo "‚ùå –ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ: $COLOR"
  exit 1
fi

if [ ! -d "$RELEASE_DIR" ]; then
  echo "‚ùå –ü–∞–ø–∫–∞ —Ä–µ–ª—ñ–∑—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞: $RELEASE_DIR"
  exit 1
fi

echo "üöÄ –î–µ–ø–ª–æ–π Symfony —É $COLOR —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ"
cd "$RELEASE_DIR"

# üîó Shared .env.local
rm -f "$RELEASE_DIR/.env.prod"
ln -sfn /var/www/manager.filkx.com/shared/.env.prod "$RELEASE_DIR/.env.prod"

# üõë –ó—É–ø–∏–Ω–∫–∞ –ø–æ—Ç–æ—á–Ω–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤
echo "üõë –ó—É–ø–∏–Ω–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤..."
docker-compose -f "$DOCKER_COMPOSE_FILE" down

# üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤
echo "üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤..."
docker-compose -f "$DOCKER_COMPOSE_FILE" -f docker-compose-production.yml up -d --build

# üîê –ü—Ä–∞–≤–∞ –Ω–∞ var
docker-compose -f "$DOCKER_COMPOSE_FILE" exec -T -w "$WORKDIR_IN_CONTAINER" php chown -R www-data:www-data var
docker-compose -f "$DOCKER_COMPOSE_FILE" exec -T -w "$WORKDIR_IN_CONTAINER" php chmod -R 775 var

# ‚öôÔ∏è –ú—ñ–≥—Ä–∞—Ü—ñ—ó
echo "‚öôÔ∏è Doctrine –º—ñ–≥—Ä–∞—Ü—ñ—ó..."
docker-compose -f "$DOCKER_COMPOSE_FILE" exec -T -w "$WORKDIR_IN_CONTAINER" php bin/console doctrine:migrations:migrate --no-interaction

# üßπ –ö–µ—à—É–≤–∞–Ω–Ω—è
echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Ç–∞ –∫–µ—à—É–≤–∞–Ω–Ω—è..."
docker-compose -f "$DOCKER_COMPOSE_FILE" exec -T -w "$WORKDIR_IN_CONTAINER" php bin/console cache:clear
docker-compose -f "$DOCKER_COMPOSE_FILE" exec -T -w "$WORKDIR_IN_CONTAINER" php bin/console cache:warmup

# üîó –ü–µ—Ä–µ–º–∏–∫–∞—î–º–æ current
ln -sfn "$APP_DIR/$COLOR/current" "$APP_DIR/current"

echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –ê–∫—Ç–∏–≤–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ ‚Äî $COLOR"
